name: Production Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  versioning:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          release_branches: main

  build-windows:
    needs: versioning
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Install Python dependencies & Build Exe
        # No Windows o limite de 4GB Ã© mais difÃ­cil de atingir ou o onefile lida melhor,
        # mas adicionamos exclusÃµes para economizar espaÃ§o
        run: |
          pip install -r assets/python/requirements.txt
          pip install pyinstaller
          pyinstaller --onefile --noconsole --distpath assets/python --name omr_worker --exclude-module tensorboard --exclude-module notebook --exclude-module matplotlib.tests assets/python/omr_worker.py
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true
      - name: Update pubspec version
        run: |
          $VERSION = "${{ needs.versioning.outputs.new_tag }}".Substring(1)
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
        shell: powershell
      - name: Get Dependencies
        run: flutter pub get
      - name: Build Windows Release
        run: flutter build windows --release
      - name: Compress Build
        run: |
          cd build/windows/x64/runner/Release
          compress-archive -Path * -DestinationPath ..\..\..\..\..\corretor_windows_${{ needs.versioning.outputs.new_tag }}.zip
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: corretor_windows_${{ needs.versioning.outputs.new_tag }}.zip

  build-linux:
    needs: versioning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev fuse

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Build Python Worker (Onedir Mode)
        # AQUI ESTÃ A CORREÃ‡ÃƒO:
        # 1. Usamos --onedir para evitar o limite de 4GB do PyInstaller
        # 2. Criamos um script wrapper para que o Flutter continue chamando 'assets/python/omr_worker'
        run: |
          pip install -r assets/python/requirements.txt
          pip install pyinstaller

          # Compila em modo diretÃ³rio para 'assets/python/omr_dist'
          # ExcluÃ­mos mÃ³dulos pesados e inÃºteis para inferÃªncia (tensorboard, notebook)
          pyinstaller --onedir --noconsole --clean \
            --distpath assets/python \
            --name omr_dist \
            --contents-directory libs \
            --exclude-module tensorboard \
            --exclude-module notebook \
            --exclude-module share \
            assets/python/omr_worker.py

          # Cria o script wrapper que o Flutter vai executar
          # Esse script entra na pasta omr_dist e executa o binÃ¡rio real
          echo '#!/bin/bash' > assets/python/omr_worker
          echo 'DIR="$(dirname "$(readlink -f "$0")")"' >> assets/python/omr_worker
          echo 'export LD_LIBRARY_PATH="$DIR/omr_dist:$LD_LIBRARY_PATH"' >> assets/python/omr_worker
          echo '"$DIR/omr_dist/omr_dist" "$@"' >> assets/python/omr_worker

          chmod +x assets/python/omr_worker

          # Remove o script original .py e arquivos temporÃ¡rios para nÃ£o ir no pacote final
          rm assets/python/omr_worker.py
          rm -rf build/omr_dist

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Update pubspec version
        run: |
          VERSION=${{ needs.versioning.outputs.new_tag }}
          VERSION=${VERSION#v}
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Linux Release
        run: flutter build linux --release

      - name: Package as AppImage
        run: |
          mkdir -p AppDir
          cp -r build/linux/x64/release/bundle/* AppDir/
          cp assets/images/sesi-logo.png AppDir/corretor_desktop.png

          cat > AppDir/corretor_desktop.desktop <<EOF
          [Desktop Entry]
          Name=Corretor Desktop
          Exec=corretor_desktop
          Icon=corretor_desktop
          Type=Application
          Categories=Utility;Education;
          Comment=Corretor AutomÃ¡tico de Provas
          EOF

          cd AppDir
          ln -s corretor_desktop AppRun
          cd ..

          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract

          # A variÃ¡vel ARCH costuma ser necessÃ¡ria para o appimagetool
          ARCH=x86_64 ./squashfs-root/AppRun AppDir "corretor_linux_${{ needs.versioning.outputs.new_tag }}.AppImage"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: "*.AppImage"

  create-release:
    needs: [versioning, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-build"
          merge-multiple: true
          path: artifacts

      - name: Generate Release Body
        id: release_body
        run: |
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸš€ AlteraÃ§Ãµes na versÃ£o ${{ needs.versioning.outputs.new_tag }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**PR:** ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“ Notas:" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "_Build gerada automaticamente via GitHub Actions_" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.versioning.outputs.new_tag }}
          name: Release ${{ needs.versioning.outputs.new_tag }}
          body: ${{ steps.release_body.outputs.BODY }}
          draft: false
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
