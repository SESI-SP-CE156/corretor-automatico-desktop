name: Production Release

on:
  workflow_dispatch:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  # 1. Versionamento Autom치tico
  versioning:
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          release_branches: main

  # 2. Build Windows
  build-windows:
    needs: versioning
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Update pubspec version
        run: |
          $VERSION = "${{ needs.versioning.outputs.new_tag }}".Substring(1)
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml
        shell: powershell

      - name: Get Dependencies
        run: flutter pub get

      # O Flutter vai copiar automaticamente a pasta assets/python e assets/models
      # para dentro de build/windows/x64/runner/Release/data/flutter_assets/
      - name: Build Windows Release
        run: flutter build windows --release

      - name: Compress Build
        run: |
          cd build/windows/x64/runner/Release
          compress-archive -Path * -DestinationPath ..\..\..\..\..\corretor_windows_${{ needs.versioning.outputs.new_tag }}.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: corretor_windows_${{ needs.versioning.outputs.new_tag }}.zip

  # 3. Build Linux (AppImage)
  build-linux:
    needs: versioning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Update pubspec version
        run: |
          VERSION=${{ needs.versioning.outputs.new_tag }}
          VERSION=${VERSION#v}
          sed -i "s/^version: .*/version: $VERSION/" pubspec.yaml

      - name: Get Dependencies
        run: flutter pub get

      - name: Build Linux Release
        run: flutter build linux --release

      # Empacotamento AppImage
      - name: Package as AppImage
        run: |
          # Cria estrutura
          mkdir -p AppDir

          # Cria diret칩rio de bibliotecas e copia o sqlite do sistema renomeando para o que o Dart espera
          mkdir -p AppDir/usr/lib
          cp /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 AppDir/usr/lib/libsqlite3.so
          cp /usr/lib/x86_64-linux-gnu/libsqlite3.so.0 AppDir/usr/lib/libsqlite3.so.0

          # Copia o bundle gerado pelo Flutter (inclui assets/python dentro de data/flutter_assets)
          cp -r build/linux/x64/release/bundle/* AppDir/

          # Configura 칤cone e metadados
          cp assets/images/sesi-logo.png AppDir/corretor_desktop.png

          cat > AppDir/corretor_desktop.desktop <<EOF
          [Desktop Entry]
          Name=Corretor Desktop
          Exec=corretor_desktop
          Icon=corretor_desktop
          Type=Application
          Categories=Utility;Education;
          Comment=Corretor Autom치tico de Provas
          EOF

          # 2. Criar script AppRun
          cat > AppDir/AppRun <<EOF
          #!/bin/sh

          # Pega o diret칩rio onde o AppImage est치 montado
          HERE="\$(dirname "\$(readlink -f "\${0}")")"

          # Adiciona a pasta interna usr/lib ao caminho de busca de bibliotecas
          export LD_LIBRARY_PATH="\${HERE}/usr/lib:\$LD_LIBRARY_PATH"

          # Executa o bin치rio do Flutter
          exec "\${HERE}/corretor_desktop" "\$@"
          EOF

          chmod +x AppDir/AppRun

          # Gera o AppImage
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract

          ARCH=x86_64 ./squashfs-root/AppRun AppDir "corretor_linux_${{ needs.versioning.outputs.new_tag }}.AppImage"

          # Remove a ferramenta baixada para n칚o ir para o upload
          rm appimagetool-x86_64.AppImage
          rm -rf squashfs-root

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: "corretor_linux_*.AppImage"

  # 4. Criar Release no GitHub
  create-release:
    needs: [versioning, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-build"
          merge-multiple: true
          path: artifacts

      - name: Generate Release Body
        id: release_body
        run: |
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          echo "## 游 Nova Vers칚o Dispon칤vel: ${{ needs.versioning.outputs.new_tag }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**Altera칞칫es:** ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "*Nota: O Python ser치 configurado automaticamente na primeira execu칞칚o do software.*" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.versioning.outputs.new_tag }}
          name: Release ${{ needs.versioning.outputs.new_tag }}
          body: ${{ steps.release_body.outputs.BODY }}
          draft: false
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
